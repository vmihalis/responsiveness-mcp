---
phase: 06-file-output
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/output/types.ts
  - src/output/organizer.ts
  - src/output/index.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Timestamped output folder is created at ./screenshots/YYYY-MM-DD-HHmmss/"
    - "Category subdirectories phones/, tablets/, pc-laptops/ exist inside output folder"
    - "Screenshots are saved with device-name-widthxheight.png naming"
    - "Filenames contain only lowercase letters, numbers, and hyphens"
    - "All successful screenshots from executor results are saved to correct category folders"
  artifacts:
    - path: "src/output/types.ts"
      provides: "SaveResult, SaveAllResult, CreateOutputOptions types"
      contains: "SaveResult"
    - path: "src/output/organizer.ts"
      provides: "generateTimestamp, createOutputDirectory, writeScreenshot, saveAllScreenshots"
      exports: ["generateTimestamp", "createOutputDirectory", "writeScreenshot", "saveAllScreenshots"]
    - path: "src/output/index.ts"
      provides: "Re-exports all output functions and types"
      contains: "saveAllScreenshots"
  key_links:
    - from: "src/output/organizer.ts"
      to: "node:fs/promises"
      via: "import { mkdir, writeFile }"
      pattern: "import.*from 'node:fs/promises'"
    - from: "src/output/organizer.ts"
      to: "node:path"
      via: "import { join }"
      pattern: "import.*from 'node:path'"
---

<objective>
Implement file output system to save screenshots in organized folder structure.

Purpose: Enable saving captured screenshots to disk with proper organization by device category
and filesystem-safe naming. This fulfills DEV-02 (category folders) and OUT-01 (descriptive names).

Output:
- Types for save operations (SaveResult, SaveAllResult, CreateOutputOptions)
- Functions: generateTimestamp(), createOutputDirectory(), writeScreenshot(), saveAllScreenshots()
- Organized output: ./screenshots/YYYY-MM-DD-HHmmss/{phones,tablets,pc-laptops}/
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-file-output/06-RESEARCH.md

@src/output/types.ts
@src/output/organizer.ts
@src/output/index.ts
@src/devices/types.ts
@src/engine/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add file output types</name>
  <files>src/output/types.ts</files>
  <action>
Add the following types to types.ts (keep existing types):

```typescript
/**
 * Options for creating output directory
 */
export interface CreateOutputOptions {
  /** Base directory (default: './screenshots') */
  baseDir?: string;
  /** Override timestamp for testing (default: auto-generated) */
  timestamp?: string;
}

/**
 * Result of saving a single screenshot
 */
export interface SaveResult {
  success: boolean;
  /** Full path where file was saved */
  filepath?: string;
  /** Error message if save failed */
  error?: string;
  /** Device name for reference */
  deviceName: string;
}

/**
 * Result of saving all screenshots from a capture run
 */
export interface SaveAllResult {
  /** Individual save results */
  results: SaveResult[];
  /** Output directory path */
  outputDir: string;
  /** Count of successfully saved files */
  savedCount: number;
  /** Count of files that failed to save */
  failedCount: number;
}
```

Import Device type if needed for type inference later.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>types.ts exports CreateOutputOptions, SaveResult, SaveAllResult alongside existing types</done>
</task>

<task type="auto">
  <name>Task 2: Implement file output functions</name>
  <files>src/output/organizer.ts</files>
  <action>
Implement the file output functions in organizer.ts. Update imports and implement:

1. **generateTimestamp()**: Returns filesystem-safe timestamp string
   - Format: "YYYY-MM-DD-HHmmss" (no colons for Windows compatibility)
   - Use Date.toISOString() with replacements

2. **createOutputDirectory(options)**: Creates timestamped output folder with category subdirs
   - Default baseDir: './screenshots'
   - Create folder: {baseDir}/{timestamp}/
   - Create subdirs: phones/, tablets/, pc-laptops/ using mkdir({ recursive: true })
   - Return the full output directory path
   - Use Promise.all for parallel dir creation

3. **writeScreenshot(options)**: Save single screenshot buffer to file
   - Parameters: { outputDir, category, filename, buffer }
   - Construct path: join(outputDir, category, filename)
   - Write buffer with writeFile
   - Return filepath

4. **generateFilename(deviceName, width, height)**: Already partially implemented
   - Fix: trim leading/trailing hyphens from safeName
   - Format: device-name-widthxheight.png

5. **saveAllScreenshots(results, devices, outputDir)**: Save all successful captures
   - Parameters: ExecutionResult[], Device[], outputDir string
   - For each result with success=true and buffer, save to correct category
   - Match result.deviceName to device in devices array to get category
   - Return SaveAllResult with counts and individual results

Implementation patterns from research:
```typescript
import { mkdir, writeFile } from 'node:fs/promises';
import { join } from 'node:path';
```

Handle errors gracefully - failed saves should return error in SaveResult, not throw.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Manual test: Create a simple test script that:
1. Calls createOutputDirectory()
2. Writes a test PNG buffer
3. Verifies files exist
  </verify>
  <done>
- generateTimestamp() returns "YYYY-MM-DD-HHmmss" format
- createOutputDirectory() creates ./screenshots/{timestamp}/{phones,tablets,pc-laptops}/
- writeScreenshot() saves buffer to correct path
- generateFilename() produces clean device-name-widthxheight.png
- saveAllScreenshots() saves all successful captures and returns stats
  </done>
</task>

<task type="auto">
  <name>Task 3: Update exports and verify integration</name>
  <files>src/output/index.ts</files>
  <action>
Update index.ts to export all new types and functions:

1. Add new type exports: CreateOutputOptions, SaveResult, SaveAllResult
2. Add new function exports: generateTimestamp, createOutputDirectory, writeScreenshot, saveAllScreenshots

Ensure the exports are properly organized (types first, then functions).

After updating exports, verify the build works:
```bash
npm run build
```
  </action>
  <verify>
`npm run build` succeeds without errors
`ls dist/` shows compiled output
  </verify>
  <done>
- All types exported from src/output/index.ts
- All functions exported from src/output/index.ts
- Build completes successfully
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npx tsc --noEmit` - TypeScript compiles without errors
2. `npm run build` - Build succeeds
3. Manual verification: Run a quick script to test directory creation:
   ```bash
   node -e "
   import('./dist/output/organizer.js').then(async ({ generateTimestamp, createOutputDirectory }) => {
     console.log('Timestamp:', generateTimestamp());
     const dir = await createOutputDirectory();
     console.log('Created:', dir);
   }).catch(console.error);
   "
   ```
</verification>

<success_criteria>
1. Types defined: CreateOutputOptions, SaveResult, SaveAllResult
2. Functions work: generateTimestamp, createOutputDirectory, writeScreenshot, saveAllScreenshots
3. Output structure: ./screenshots/YYYY-MM-DD-HHmmss/{phones,tablets,pc-laptops}/
4. Filenames: lowercase, hyphens, dimensions (e.g., iphone-14-pro-393x852.png)
5. Build passes with all exports available
</success_criteria>

<output>
After completion, create `.planning/phases/06-file-output/06-01-SUMMARY.md`
</output>

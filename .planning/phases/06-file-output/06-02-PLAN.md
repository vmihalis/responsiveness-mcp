---
phase: 06-file-output
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/output/__tests__/organizer.test.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Unit tests verify timestamp format is YYYY-MM-DD-HHmmss"
    - "Unit tests verify filename sanitization removes special characters"
    - "Unit tests verify directory creation with category subdirs"
    - "Unit tests verify screenshot writing to correct paths"
    - "Unit tests verify saveAllScreenshots aggregates results correctly"
  artifacts:
    - path: "src/output/__tests__/organizer.test.ts"
      provides: "Unit tests for file output module"
      min_lines: 100
  key_links:
    - from: "src/output/__tests__/organizer.test.ts"
      to: "src/output/organizer.ts"
      via: "import functions"
      pattern: "import.*from.*organizer"
---

<objective>
Create comprehensive unit tests for the file output system.

Purpose: Verify that timestamp generation, filename sanitization, directory creation, and
file writing all work correctly across edge cases. Ensures DEV-02 and OUT-01 requirements
are properly implemented.

Output:
- Test file: src/output/__tests__/organizer.test.ts
- Tests for: generateTimestamp, generateFilename, createOutputDirectory, writeScreenshot, saveAllScreenshots
- Edge cases: special characters, empty inputs, failed saves
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/06-file-output/06-01-SUMMARY.md

@src/output/types.ts
@src/output/organizer.ts
@src/devices/types.ts
@src/engine/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create test file with timestamp and filename tests</name>
  <files>src/output/__tests__/organizer.test.ts</files>
  <action>
Create the test file src/output/__tests__/organizer.test.ts with Vitest.

First, create the __tests__ directory if needed.

Write tests for generateTimestamp and generateFilename:

```typescript
import { describe, it, expect, beforeEach, afterEach } from 'vitest';
import { rm, readdir, readFile, stat } from 'node:fs/promises';
import { join } from 'node:path';
import {
  generateTimestamp,
  generateFilename,
  createOutputDirectory,
  writeScreenshot,
  saveAllScreenshots,
} from '../organizer.js';
import type { ExecutionResult } from '../../engine/types.js';
import type { Device } from '../../devices/types.js';
```

**generateTimestamp tests:**
- Returns string in YYYY-MM-DD-HHmmss format (regex: /^\d{4}-\d{2}-\d{2}-\d{6}$/)
- Does not contain colons (Windows-safe)
- Does not contain T or Z from ISO format
- Two calls close together produce same or incremented timestamp

**generateFilename tests:**
- Basic device name: "iPhone 14 Pro" -> "iphone-14-pro-393x852.png"
- Device with special chars: "MacBook Pro 16\"" -> "macbook-pro-16-1728x1117.png"
- Multiple spaces: "Samsung  Galaxy   S23" -> "samsung-galaxy-s23-360x780.png"
- Leading/trailing spaces: " Test Device " -> "test-device-100x100.png"
- Numbers preserved: "Pixel 8 Pro" -> "pixel-8-pro-412x915.png"
- Returns .png extension always
  </action>
  <verify>`npm test -- src/output/__tests__/organizer.test.ts` runs timestamp and filename tests</verify>
  <done>Tests pass for generateTimestamp and generateFilename functions</done>
</task>

<task type="auto">
  <name>Task 2: Add directory creation and file writing tests</name>
  <files>src/output/__tests__/organizer.test.ts</files>
  <action>
Add tests for createOutputDirectory and writeScreenshot to the existing test file.

Use a temp directory for tests to avoid polluting the project:

```typescript
const TEST_BASE_DIR = join(process.cwd(), '.test-output');

beforeEach(async () => {
  // Clean test directory
  await rm(TEST_BASE_DIR, { recursive: true, force: true });
});

afterEach(async () => {
  // Cleanup after tests
  await rm(TEST_BASE_DIR, { recursive: true, force: true });
});
```

**createOutputDirectory tests:**
- Creates timestamped folder in baseDir
- Creates phones/, tablets/, pc-laptops/ subdirectories
- Returns the full output path
- Works with custom timestamp override (for deterministic testing)
- Creates nested directories (mkdir recursive)
- Handles baseDir that doesn't exist yet

**writeScreenshot tests:**
- Writes buffer to correct path: {outputDir}/{category}/{filename}
- Returns the written filepath
- File contents match input buffer
- Creates file with .png content (verify first bytes are PNG magic: 0x89 0x50 0x4E 0x47)

Create a minimal valid PNG for testing (or use a simple Buffer with predictable content).
  </action>
  <verify>`npm test -- src/output/__tests__/organizer.test.ts` runs directory and file tests</verify>
  <done>Tests pass for createOutputDirectory and writeScreenshot functions</done>
</task>

<task type="auto">
  <name>Task 3: Add saveAllScreenshots integration tests</name>
  <files>src/output/__tests__/organizer.test.ts</files>
  <action>
Add tests for saveAllScreenshots to the existing test file.

**saveAllScreenshots tests:**

1. Saves all successful results:
   - Create mock ExecutionResult[] with 3 successes (phone, tablet, pc-laptop)
   - Create matching Device[] array
   - Call saveAllScreenshots
   - Verify files exist in correct category folders
   - Verify savedCount = 3, failedCount = 0

2. Skips failed results:
   - Mix of success (with buffer) and failure (no buffer)
   - Only successful ones should create files
   - failedCount reflects skipped count

3. Handles empty results:
   - Empty array input
   - Returns savedCount = 0, failedCount = 0
   - outputDir still valid

4. Handles all failures:
   - All results have success=false
   - No files written
   - savedCount = 0

5. Matches device by name:
   - Result.deviceName must match Device.name
   - Correct category used for file placement

Create test fixtures:
```typescript
const createTestDevice = (name: string, category: Device['category']): Device => ({
  name,
  width: 100,
  height: 200,
  deviceScaleFactor: 1,
  category,
});

const createTestResult = (deviceName: string, success: boolean): ExecutionResult => ({
  success,
  deviceName,
  buffer: success ? Buffer.from('PNG test data') : undefined,
  attempts: 1,
});
```

Run all tests and verify the total test count increases appropriately.
  </action>
  <verify>
`npm test` runs all tests including new output tests
Total test count includes ~15-20 new tests
All tests pass
  </verify>
  <done>
- All organizer tests pass
- Tests cover: timestamp, filename, directory creation, file writing, batch saving
- Edge cases covered: special chars, empty input, mixed success/failure
- Test cleanup removes temp files
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm test` - All tests pass (should be 64 + ~15-20 = ~80+ tests)
2. `npm test -- --coverage` - Check coverage for src/output/organizer.ts is high (>80%)
3. No leftover test directories in project root
</verification>

<success_criteria>
1. Test file exists: src/output/__tests__/organizer.test.ts
2. All tests pass: `npm test` shows green
3. Coverage includes: generateTimestamp, generateFilename, createOutputDirectory, writeScreenshot, saveAllScreenshots
4. Edge cases tested: special characters, empty inputs, mixed success/failure results
5. Tests are isolated: use temp directory, clean up after
</success_criteria>

<output>
After completion, create `.planning/phases/06-file-output/06-02-SUMMARY.md`
</output>

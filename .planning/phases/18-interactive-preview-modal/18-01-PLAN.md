---
phase: 18-interactive-preview-modal
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/output/reporter.ts
  - src/output/__tests__/reporter.test.ts
autonomous: true

must_haves:
  truths:
    - "User can click any screenshot thumbnail to open preview modal"
    - "Preview modal displays iframe sized to device dimensions"
    - "Loading spinner visible while iframe loads"
    - "User can close modal via close button"
    - "User can close modal via ESC key"
    - "User can close modal via backdrop click"
    - "Error message shown when site blocks iframe embedding"
    - "Open in new tab fallback link available in error state"
  artifacts:
    - path: "src/output/reporter.ts"
      provides: "Modal template generation, thumbnail with preview trigger"
      exports: ["generateModalTemplate", "renderThumbnailCard (updated)"]
    - path: "src/output/__tests__/reporter.test.ts"
      provides: "Tests for modal template and preview functionality"
      min_lines: 20
  key_links:
    - from: "thumbnail button onclick"
      to: "window.openPreview function"
      via: "inline onclick handler"
      pattern: "onclick=\"openPreview\\("
    - from: "openPreview function"
      to: "dialog.showModal()"
      via: "JavaScript in modal template"
      pattern: "modal\\.showModal\\(\\)"
    - from: "iframe load timeout"
      to: "error state display"
      via: "setTimeout callback"
      pattern: "setTimeout.*showError"
---

<objective>
Add interactive preview modal to HTML report allowing users to test the live site at any device dimensions via iframe.

Purpose: Enable users to interactively explore the captured site at exact device viewport sizes without leaving the report
Output: Updated reporter generating HTML with native <dialog> modal, iframe preview, loading/error states, and keyboard accessibility
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-interactive-preview-modal/18-RESEARCH.md
@src/output/reporter.ts
@src/output/types.ts
@src/output/__tests__/reporter.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add modal template generation to reporter</name>
  <files>src/output/reporter.ts</files>
  <action>
Add new function `generateModalTemplate(url: string): string` that returns the complete modal HTML including:

1. **Dialog element** with native `<dialog>` tag:
   - id="preview-modal"
   - class="preview-modal"
   - No closedby attribute (Safari compatibility - handle manually)

2. **Modal structure**:
   - Header with close button (X) with autofocus and aria-label
   - Body containing:
     - Loading state div with CSS spinner animation and "Loading preview..." text
     - Hidden iframe with sandbox="allow-scripts allow-forms allow-same-origin"
     - Hidden error state with warning icon, message, and "Open in New Tab" fallback link

3. **CSS styles** (add to CSS_STYLES constant):
   - .preview-modal styles: border:none, border-radius:8px, max-width:95vw, max-height:95vh, box-shadow
   - .preview-modal::backdrop: background: rgba(0,0,0,0.8)
   - .modal-header, .close-btn with hover and focus-visible states
   - .modal-body positioning
   - .preview-iframe: display:block, border, border-radius
   - .loading-state: flex column centered, padding
   - .spinner: CSS animation with border-top colored, @keyframes spin
   - .error-state: centered text, SVG icon styling
   - .fallback-btn: styled link button with hover state

4. **JavaScript** (inline IIFE in template):
   - Get references to modal, closeBtn, iframe, loadingState, errorState, fallbackLink
   - Track previouslyFocusedElement for focus restoration
   - IFRAME_TIMEOUT_MS = 10000 (10 seconds)
   - openPreview(url, width, height) function:
     - Store document.activeElement
     - Reset states (show loading, hide iframe, hide error)
     - Set iframe dimensions with Math.min for viewport constraints (0.9 * innerWidth, 0.8 * innerHeight)
     - Set fallbackLink.href = url
     - Call modal.showModal()
     - Call loadIframeWithTimeout(iframe, url)
   - loadIframeWithTimeout(iframe, url) function:
     - Set timeout to show error after IFRAME_TIMEOUT_MS
     - Add load event listener (once:true) to clear timeout and show iframe
     - Set iframe.src = url
   - showIframe() and showError() helper functions
   - closeModal() function: close dialog, set iframe.src='about:blank', restore focus
   - Event listeners:
     - closeBtn click -> closeModal()
     - modal click -> if target===modal, closeModal() (backdrop click)
     - modal close event -> cleanup iframe src, restore focus
   - Expose window.openPreview = openPreview

5. **Integrate into buildReportHtml**:
   - Call generateModalTemplate(data.url) and include after lightboxes
   - Pass url from ReportData to modal template

Reference 18-RESEARCH.md "Complete Modal Implementation" section for exact patterns.
  </action>
  <verify>
Run `npm run build` - TypeScript compiles without errors.
Run `npm test -- --run reporter` - existing tests pass.
  </verify>
  <done>
generateModalTemplate function exists and returns complete modal HTML with dialog, CSS, and JavaScript.
buildReportHtml includes modal template in output.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update thumbnail cards to trigger preview modal</name>
  <files>src/output/reporter.ts</files>
  <action>
Modify renderThumbnailCard function to add preview capability while preserving existing lightbox:

1. **Update function signature**:
   - Add `url: string` parameter: `renderThumbnailCard(screenshot: ScreenshotForReport, url: string): string`

2. **Keep the existing lightbox anchor** (for screenshot viewing):
   - Keep the `<a href="#${lightboxId}">` link for the static screenshot lightbox
   - CSS lightbox still works for viewing the full screenshot

3. **Add preview button overlay**:
   - Add a button element inside thumbnail-card with:
     - class="preview-btn"
     - type="button"
     - onclick="openPreview('${escapeHtml(url)}', ${screenshot.width}, ${screenshot.height})"
     - aria-label="Preview ${escapeHtml(screenshot.deviceName)} at ${screenshot.width}x${screenshot.height}"
     - Position it as overlay in corner (absolute positioned)

4. **Add CSS for preview button** (in CSS_STYLES):
   ```css
   .preview-btn {
     position: absolute;
     top: 0.5rem;
     right: 0.5rem;
     background: rgba(0, 102, 204, 0.9);
     color: white;
     border: none;
     border-radius: 4px;
     padding: 0.25rem 0.5rem;
     font-size: 0.75rem;
     cursor: pointer;
     opacity: 0;
     transition: opacity 0.2s;
     z-index: 5;
   }

   .thumbnail-card:hover .preview-btn {
     opacity: 1;
   }

   .preview-btn:hover {
     background: rgba(0, 82, 163, 0.95);
   }

   .preview-btn:focus-visible {
     opacity: 1;
     outline: 2px solid white;
     outline-offset: 2px;
   }
   ```

5. **Update renderCategory call**:
   - Pass url to renderThumbnailCard
   - Update renderCategory signature to accept url: `renderCategory(category, screenshots, url)`

6. **Update buildReportHtml**:
   - Pass data.url to renderCategory calls

This approach preserves the existing CSS-only lightbox for screenshot viewing while adding the interactive preview as a separate action.
  </action>
  <verify>
Run `npm run build` - TypeScript compiles without errors.
Manually verify the HTML output includes preview button in thumbnail cards.
  </verify>
  <done>
Thumbnail cards include preview button overlay that triggers openPreview().
Existing lightbox functionality preserved for screenshot viewing.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add tests for modal template and preview functionality</name>
  <files>src/output/__tests__/reporter.test.ts</files>
  <action>
Add comprehensive tests for the new modal functionality:

1. **Test generateModalTemplate function**:
   ```typescript
   describe('generateModalTemplate', () => {
     it('returns HTML with dialog element', () => {
       const html = generateModalTemplate('https://example.com');
       expect(html).toContain('<dialog');
       expect(html).toContain('id="preview-modal"');
     });

     it('includes close button with accessibility attributes', () => {
       const html = generateModalTemplate('https://example.com');
       expect(html).toContain('aria-label="Close preview"');
       expect(html).toContain('autofocus');
     });

     it('includes loading state with spinner', () => {
       const html = generateModalTemplate('https://example.com');
       expect(html).toContain('id="loading-state"');
       expect(html).toContain('class="spinner"');
       expect(html).toContain('Loading preview');
     });

     it('includes iframe with security sandbox', () => {
       const html = generateModalTemplate('https://example.com');
       expect(html).toContain('<iframe');
       expect(html).toContain('id="preview-iframe"');
       expect(html).toContain('sandbox="allow-scripts allow-forms allow-same-origin"');
     });

     it('includes error state with fallback link', () => {
       const html = generateModalTemplate('https://example.com');
       expect(html).toContain('id="error-state"');
       expect(html).toContain('id="fallback-link"');
       expect(html).toContain('Open in New Tab');
       expect(html).toContain('target="_blank"');
       expect(html).toContain('rel="noopener noreferrer"');
     });

     it('includes openPreview JavaScript function', () => {
       const html = generateModalTemplate('https://example.com');
       expect(html).toContain('window.openPreview = openPreview');
       expect(html).toContain('function openPreview(url, width, height)');
     });

     it('includes iframe timeout detection', () => {
       const html = generateModalTemplate('https://example.com');
       expect(html).toContain('IFRAME_TIMEOUT_MS');
       expect(html).toContain('setTimeout');
     });

     it('includes backdrop click handler', () => {
       const html = generateModalTemplate('https://example.com');
       expect(html).toContain('e.target === modal');
     });

     it('includes focus restoration on close', () => {
       const html = generateModalTemplate('https://example.com');
       expect(html).toContain('previouslyFocusedElement');
       expect(html).toContain('.focus()');
     });
   });
   ```

2. **Test renderThumbnailCard with preview button**:
   ```typescript
   describe('renderThumbnailCard with preview', () => {
     const mockScreenshot: ScreenshotForReport = {
       deviceName: 'iPhone 14',
       category: 'phones',
       width: 390,
       height: 844,
       dataUri: 'data:image/png;base64,test',
       screenshotWidth: 390,
       screenshotHeight: 2000,
       foldPositionLightbox: 42.2,
       foldPositionThumbnail: 65.0,
     };

     it('includes preview button with onclick handler', () => {
       const html = renderThumbnailCard(mockScreenshot, 'https://example.com');
       expect(html).toContain('class="preview-btn"');
       expect(html).toContain('onclick="openPreview(');
     });

     it('preview button has correct dimensions in onclick', () => {
       const html = renderThumbnailCard(mockScreenshot, 'https://example.com');
       expect(html).toContain('openPreview(\'https://example.com\', 390, 844)');
     });

     it('preview button has accessibility label', () => {
       const html = renderThumbnailCard(mockScreenshot, 'https://example.com');
       expect(html).toContain('aria-label="Preview iPhone 14 at 390x844"');
     });

     it('escapes URL in onclick handler', () => {
       const html = renderThumbnailCard(mockScreenshot, 'https://example.com?a=1&b=2');
       expect(html).toContain('https://example.com?a=1&amp;b=2');
     });

     it('preserves lightbox anchor for screenshot viewing', () => {
       const html = renderThumbnailCard(mockScreenshot, 'https://example.com');
       expect(html).toContain('href="#lb-');
       expect(html).toContain('class="thumbnail-link"');
     });
   });
   ```

3. **Test buildReportHtml includes modal**:
   ```typescript
   describe('buildReportHtml with modal', () => {
     it('includes modal dialog in generated HTML', () => {
       // Use existing test data setup
       const data: ReportData = {
         url: 'https://example.com',
         capturedAt: '2026-01-21',
         duration: 5000,
         deviceCount: 1,
         files: [],
       };
       const screenshots: ScreenshotForReport[] = [{
         deviceName: 'Test Device',
         category: 'phones',
         width: 375,
         height: 812,
         dataUri: 'data:image/png;base64,test',
         screenshotWidth: 375,
         screenshotHeight: 1500,
         foldPositionLightbox: 54.13,
         foldPositionThumbnail: 84.3,
       }];

       const html = buildReportHtml(data, screenshots);
       expect(html).toContain('<dialog id="preview-modal"');
       expect(html).toContain('window.openPreview');
     });
   });
   ```

4. **Export generateModalTemplate and buildReportHtml** if not already exported (for testing).
   - Check if buildReportHtml is exported; if not internal, test via generateReport output
  </action>
  <verify>
Run `npm test -- --run reporter` - all tests pass including new modal tests.
Run `npm test` - full test suite passes.
  </verify>
  <done>
New tests cover modal template generation, preview button rendering, and integration.
All 90+ tests pass (existing 71+ new ~20).
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Build verification:**
   ```bash
   npm run build
   ```
   TypeScript compiles without errors.

2. **Test verification:**
   ```bash
   npm test
   ```
   All tests pass (90+ total).

3. **Manual verification:**
   ```bash
   npx screenie https://example.com --phones-only
   ```
   - Open generated report.html in browser
   - Hover over thumbnail - preview button appears
   - Click preview button - modal opens with loading spinner
   - If site allows iframe: iframe shows site at device dimensions
   - If site blocks iframe: error state with "Open in New Tab" link
   - Press ESC - modal closes
   - Click backdrop - modal closes
   - Click X button - modal closes
   - Click thumbnail image - existing lightbox still works
</verification>

<success_criteria>
1. Modal opens when preview button clicked - PREV-01
2. Iframe sized to device dimensions (width x height) - PREV-02
3. Loading spinner shown while iframe loads - PREV-03
4. Close button closes modal - PREV-04
5. ESC key closes modal - PREV-05
6. Error message shown for blocked iframes (via timeout) - PREV-06
7. "Open in New Tab" fallback link in error state - PREV-07
8. All existing tests continue to pass
9. New tests cover modal functionality
</success_criteria>

<output>
After completion, create `.planning/phases/18-interactive-preview-modal/18-01-SUMMARY.md`
</output>
